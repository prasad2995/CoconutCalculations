<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kobarikayalu, Karchulu & Final Amount</title>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #ffffff;
      --text: #1a202c;
      --muted: #4a5568;
      --accent: #047857;
      --accent-2: #0ea5e9;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans Telugu", "Noto Sans", sans-serif;
      background: var(--bg); color: var(--text);
      line-height: 1.45;
    }

    /* outer page container */
    .wrap { max-width: 720px; margin: 16px auto; padding: 12px; }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06); overflow: hidden;
    }
    header { padding: 12px 16px; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #fff; font-weight:700; }
    .content { padding: 10px 14px; }
    .grid { display: grid; grid-template-columns: 1fr 220px; gap: 14px; align-items: center; margin-bottom:6px; }
    label { font-weight: 700; font-size: 0.95rem; }
    .muted { color: var(--muted); font-weight: 400; font-size:0.9rem; }
    input[type="number"], input[readonly], input[type="text"], textarea {
      width: 45%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px;
      font-size: 0.95rem; background: #fff;
    }
    input.small { width: 35%; }
    .row { margin-top: 12px; }
    .total {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 8px;
      font-size: 1.02rem; font-weight: 700; margin-top:6px;
    }
    .btns { display: flex; gap: 10px; margin-top: 10px; flex-wrap:wrap; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; background:#fff; font-weight:700; }
    button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .meta-row { display:flex; gap:12px; align-items:center; margin:8px 0 6px; flex-wrap:wrap; }
    .meta-row .item { display:flex; flex-direction:column; gap:6px; }

    /* header text */
    .bill-header { text-align:center; padding:10px 6px; }
    .bill-header h1 { margin:4px 0; color: #b91c1c; font-size:1.2rem; font-weight:900; }
    .bill-header h3 { margin:2px 0; font-size:0.98rem; font-weight:700; }

    /* responsive - make inputs and labels smaller on phones and keep two-column layout */
    @media (max-width: 520px) {
      .grid { grid-template-columns: 1fr 140px; gap:10px; }
      label { font-size: 0.88rem; }
      input[type="number"], input[readonly], input[type="text"] { width: 55%; padding:6px 8px; font-size:0.9rem; }
      .total { padding: 10px 12px; font-size:1rem; }
      .btns button { padding:8px 10px; font-size:0.9rem; }
      .meta-row { gap:8px; }
      .meta-row .item { min-width: 120px; }
    }

    @media (max-width: 380px) {
      .grid { grid-template-columns: 1fr 120px; gap:8px; }
      input[type="number"], input[readonly], input[type="text"] { width: 60%; }
      label { font-size: 0.86rem; }
    }

    /* print styles */
    @media print {
      @page { size:A4; margin: 12mm; }
      html, body { background: #fff; color: #000; }
      body { margin: 0; }
      .btns, .no-print { display: none !important; }
      .card { box-shadow: none; border: none; border-radius: 0; }
      .wrap { margin: 0; padding: 8mm; max-width: none; }
      input, textarea { border: 1px solid #ddd; }
    }
  </style>
</head>
<body>

<!-- capture area for printing/pdf -->
<div class="wrap" id="bill">

  <!-- header -->
  <div class="card" style="padding:10px; margin-bottom:10px;">
    <div class="bill-header">
      <h3>కొనుబడి బిల్లు</h3>
      <h1>గీతా ప్రనూష కోనసీమ కోకోనట్ బిజినెస్</h1>
      <h3> మగటపల్లి</h3>
      <div style="font-weight:700; margin-top:6px;">ప్రో: గుండాబత్తుల ప్రసాద్ | సెల్: 9177682498, 9963153332</div>
    </div>

    <!-- customer name + date -->
    <div class="meta-row" style="margin-top:8px;">
      <div class="item" style="flex:1;">
        <label style="font-size:0.95rem;">కొనుగోలుదారు పేరు</label>
        <input id="customerName" type="text" placeholder="కొనుగోలుదారు పేరు" />
      </div>

      <div class="item" style="width:180px;">
        <label style="font-size:0.95rem;">తేదీ</label>
        <!-- readonly text showing full date so year is always visible -->
        <input style="width:100px;" id="billDate" type="text" readonly />
      </div>
    </div>
  </div>

  <!-- Section 1: Kobarikayalu -->
  <div class="card" style="margin-bottom:10px;">
    <header>కొబ్బరికాయలు</header>
    <div class="content">
      <div class="grid">
        <label for="asalu">మొత్తం కొబ్బరికాయలు</label>
        <input id="asalu" name="asalu" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label for="senagalu100">సెనగలు తీసేయవలసినవి (%)</label>
        <input id="senagalu100" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label for="senagalu">సెనగలు మొత్తం</label>
        <input id="senagalu" type="number" readonly />
      </div>
      <div class="grid">
        <label>మొత్తం కాయలు (సెనగలు తీసిన తర్వాత)</label>
        <input id="finalCount" type="number" readonly />
      </div>
      <div class="grid">
        <label>రేటు (₹) 1000 కాయలకు</label>
        <input id="rate" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>

      <div class="total">
        <span>మొత్తం రుసుము</span>
        <span id="finalAmount">₹ 0.00</span>
      </div>
    </div>
  </div>

  <!-- Section 2: Karchulu -->
  <div class="card" style="margin-bottom:10px;">
    <header>ఖర్చులు</header>
    <div class="content">
      <div class="grid">
        <label>దింపు ఒక్క కొబ్బరికాయకి</label>
        <input id="dimpuPer" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label>దింపు మొత్తం (కాయలకు)</label>
        <input id="dimpuValaki" type="number" readonly />
      </div>
      <div class="grid">
        <label>లేబర్ ఖర్చులు</label>
        <input id="labour" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label>ట్రాన్స్‌పోర్ట్ ఖర్చులు</label>
        <input id="transport" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label>ఇతర ఖర్చులు</label>
        <input id="other" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>

      <div class="total">
        <span>మొత్తం ఖర్చులు</span>
        <span id="expensesFinal">₹ 0.00</span>
      </div>
    </div>
  </div>

  <!-- Section 3: Final Amount -->
  <div class="card" style="margin-bottom:18px;">
    <header>మొత్తం రుసుము</header>
    <div class="content">
      <div class="grid">
        <label>కాయలు రుసుము</label>
        <input id="amountKayalu" style="width:75%" type="text" readonly />
      </div>
      <div class="grid">
        <label>ఖర్చులు మొత్తంగా</label>
        <input id="amountKarchulu" style="width:75%" type="text" readonly />
      </div>

      <div class="total">
        <span>Final Amount</span>
        <span id="finalTotal">₹ 0.00</span>
      </div>
    </div>
  </div>

  <!-- actions -->
  <div class="card" style="padding:10px 12px; margin-bottom:12px; display:flex; align-items:center;">
    <div style="font-weight:700;">Bill actions</div>
    <div class="btns no-print" style="margin-left:auto;">
      <button onclick="doPrint('A4')">Print (A4)</button>
      <button onclick="doPrint('A5')">Print (A5)</button>
      <button class="primary" onclick="generatePDF('A4')">Generate PDF (A4)</button>
    </div>
  </div>

  <div style="text-align:center; font-size:0.9rem; color:var(--muted); margin-bottom:24px;">
    Generated on: <span id="generatedDate"></span>
  </div>

</div> <!-- end #bill -->

<!-- Scripts -->
<script>
/* helpers */
function toNumber(id){
  const el = document.getElementById(id);
  if (!el) return 0;
  const v = parseFloat(el.value.toString().replace(/[^0-9.-]/g,''));
  return isNaN(v) ? 0 : v;
}
function formatINR(n){ return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(n); }

/* recalc logic (unchanged) */
function recalc(){
  const asalu = toNumber('asalu');
  const senagalu100 = toNumber('senagalu100');
  let senagalu = 0;
  if(senagalu100 > 0){ senagalu = Math.ceil(asalu * (senagalu100/100)); }
  document.getElementById('senagalu').value = senagalu;

  const rate = toNumber('rate');
  const finalCount = Math.max(0, asalu - senagalu);
  document.getElementById('finalCount').value = finalCount;

  const kayaluAmount = finalCount * (rate/1000);
  document.getElementById('finalAmount').textContent = formatINR(kayaluAmount);

  const dimpuPer = toNumber('dimpuPer'), labour = toNumber('labour'), transport = toNumber('transport'), other = toNumber('other');
  const dimpuValaki = asalu * dimpuPer;
  document.getElementById('dimpuValaki').value = dimpuValaki;

  const karchuluAmount = dimpuValaki + labour + transport + other;
  document.getElementById('expensesFinal').textContent = formatINR(karchuluAmount);

  document.getElementById('amountKayalu').value = formatINR(kayaluAmount);
  document.getElementById('amountKarchulu').value = formatINR(karchuluAmount);

  const finalTotal = kayaluAmount - karchuluAmount;
  document.getElementById('finalTotal').textContent = formatINR(finalTotal);

  document.getElementById('generatedDate').textContent = new Date().toLocaleString('en-IN');
}

/* wire inputs */
['asalu','senagalu100','rate','dimpuPer','labour','transport','other'].forEach(id=>{
  document.getElementById(id).addEventListener('input', recalc);
});
recalc();

/* bill date display (text showing full date DD-MM-YYYY) */
(function initDate(){
  const d = new Date();
  const pad = n => n.toString().padStart(2,'0');
  const dd = pad(d.getDate()), mm = pad(d.getMonth()+1), yyyy = d.getFullYear();
  const dateStr = `${dd}-${mm}-${yyyy}`;
  const el = document.getElementById('billDate');
  if (el) el.value = dateStr;
})();

/* --- Printing: clone content into a new window and set @page size --- */
function doPrint(size = 'A4') {
  const el = document.getElementById('bill');
  if (!el) return alert('No bill found to print.');
  const content = el.outerHTML;

  // gather <style> nodes so the print window keeps the styles
  const styles = Array.from(document.querySelectorAll('style')).map(s => s.outerHTML).join('\n');

  // page style: size depends on requested paper
  const pageStyle = `<style>@page { size: ${size}; margin: 12mm; } .no-print, .btns { display: none !important; } </style>`;

  const win = window.open('', '_blank', 'noopener,width=900,height=1200');
  win.document.open();
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"> <title>Print - Bill</title> ${styles} ${pageStyle} </head><body>${content}</body></html>`);
  win.document.close();

  setTimeout(()=>{ win.focus(); win.print(); }, 500);
}

/* --- Generate PDF (better pagination) ---
   - default size: A4 (you can pass 'A5' or 'A4')
   - uses html2canvas + jsPDF loaded dynamically
   - improved mm->px conversion for correct slicing
*/
async function generatePDF(size = 'A4') {
  try {
    const btn = event?.target;
    if (btn) { btn.disabled = true; btn.textContent = 'Generating PDF...'; }

    // lazy-load libs
    if (!window.html2canvas) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    if (!window.jspdf) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

    const { jsPDF } = window.jspdf;
    const element = document.getElementById('bill');

    // choose scale modestly (higher -> sharper but taller canvas)
    const scale = 1.2;

    // render element into canvas
    const canvas = await html2canvas(element, { scale, useCORS:true, backgroundColor: '#ffffff' });

    // PDF page sizes in mm
    const pdfSizesMm = { 'A4': [210,297], 'A5': [148.5,210] };
    const [pageWidthMm, pageHeightMm] = pdfSizesMm[size] || pdfSizesMm['A4'];

    // convert mm to px for slicing (assuming 96 DPI): px = mm * (dpi / 25.4)
    const dpi = 96 * scale; // use consistent dpi relative to canvas scale
    const mmToPx = mm => Math.round(mm * (dpi / 25.4));
    const marginMm = 8;
    const pageWidthPx = mmToPx(pageWidthMm - marginMm*2);
    const pageHeightPx = mmToPx(pageHeightMm - marginMm*2);

    // total canvas size
    const fullWidth = canvas.width;
    const fullHeight = canvas.height;

    // scale factor to map canvas px to pdf display width (in mm)
    const pdf = new jsPDF({ unit: 'mm', format: [pageWidthMm, pageHeightMm], orientation: 'portrait' });
    const pageWidthMMDisplay = pageWidthMm - marginMm*2;

    // compute image display height in mm corresponding to full canvas width
    const imgDisplayWidthMM = pageWidthMMDisplay;
    const imgDisplayHeightMM = (fullHeight * imgDisplayWidthMM) / fullWidth; // mm unit when width matched

    // convert each canvas slice (in px) to mm height in PDF via ratio
    // We'll slice canvas into pageHeightPx chunks
    let y = 0;
    let pageIndex = 0;
    while (y < fullHeight) {
      const sliceHeight = Math.min(pageHeightPx, fullHeight - y);
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = fullWidth;
      tmpCanvas.height = sliceHeight;
      const ctx = tmpCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, y, fullWidth, sliceHeight, 0, 0, fullWidth, sliceHeight);
      const imgData = tmpCanvas.toDataURL('image/jpeg', 0.92);

      // compute this slice's display height in mm
      const sliceDisplayHeightMM = (sliceHeight * imgDisplayWidthMM) / fullWidth;

      if (pageIndex > 0) pdf.addPage();
      pdf.addImage(imgData, 'JPEG', marginMm, marginMm, imgDisplayWidthMM, sliceDisplayHeightMM);

      y += sliceHeight;
      pageIndex++;
    }

    // finalize
    const fileName = `bill-${new Date().toISOString().replace(/[:.]/g,'-')}.pdf`;
    const blob = pdf.output('blob');

    // trigger download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);

    // try native share (if supported)
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'application/pdf' })] })) {
      try { await navigator.share({ files: [new File([blob], fileName, { type: 'application/pdf' })], title: 'Bill PDF' }); }
      catch (err) { /* user cancelled share */ }
    }

  } catch (err) {
    console.error(err);
    alert('Failed to generate PDF — see console for details.');
  } finally {
    if (event?.target) { event.target.disabled = false; event.target.textContent = 'Generate PDF (A4)'; }
  }
}

/* load script helper */
function loadScript(src){ return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); }); }

</script>
</body>
</html>
