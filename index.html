<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kobarikayalu ‚Äî Bill</title>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #ffffff;
      --text: #1a202c;
      --muted: #4a5568;
      --accent: #047857;
      --accent-2: #0ea5e9;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans Telugu", "Noto Sans", sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.45;
    }

    /* container */
    .wrap { max-width: 720px; margin: 12px auto; padding: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); overflow: hidden; }
    header { padding: 10px 14px; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #fff; font-weight:700; }
    .content { padding: 10px 14px; }
    .grid { display: grid; grid-template-columns: 1fr 220px; gap: 12px; align-items: center; margin-bottom:8px; }
    label { font-weight: 700; font-size: 0.95rem; }
    .muted { color: var(--muted); font-weight: 400; font-size:0.9rem; }
    input[type="number"], input[readonly], input[type="text"], textarea {
      width: 45%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; background: #fff;
    }
    input.full { width: 100%; } /* for customer name bigger input */
    .meta-row { display:flex; gap:12px; align-items:center; margin:8px 0 6px; flex-wrap:wrap; }
    .meta-row .item { display:flex; flex-direction:column; gap:6px; }

    .bill-header { text-align:center; padding:10px 6px; }
    .bill-header h1 { margin:4px 0; color: red; font-size:1.2rem; font-weight:900; }
    .bill-header h3 { margin:2px 0; color: #004CA3;font-size:0.98rem; font-weight:700; }

    .total { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#f0fdf4; border:1px solid #dcfce7; border-radius:8px; font-size:1.02rem; font-weight:700; margin-top:6px; }

    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:8px; border:1px solid var(--border); cursor:pointer; background:#fff; font-weight:700; }
    button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    button.ghost { background: transparent; color: inherit; border-color: var(--border); }

    .small { width: 35%; }

    /* responsive tweaks so labels + inputs sit side-by-side on phones */
    @media (max-width: 520px) {
      .grid { grid-template-columns: 1fr 140px; gap:8px; }
      label { font-size: 0.88rem; }
      input[type="number"], input[readonly], input[type="text"] { width: 60%; padding:6px 8px; font-size:0.9rem; }
      .meta-row .item { min-width: 120px; }
    }
    @media (max-width: 380px) {
      .grid { grid-template-columns: 1fr 120px; gap:6px; }
      input[type="number"], input[readonly], input[type="text"] { width: 64%; }
    }

    /* print styles */
    @media print {
      @page { size: A4; margin: 12mm; }
      html, body { background: #fff; color: #000; } body { margin:0; }
      .btns, .no-print { display: none !important; }
      .card { box-shadow:none; border:none; border-radius:0; }
      .wrap { margin:0; padding:8mm; max-width:none; }
      input, textarea { border: 1px solid #ddd; }
    }
  </style>
</head>
<body>

<!-- Bill capture area -->
<div class="wrap" id="bill">

  <!-- Header -->
  <div class="card" style="padding:10px; margin-bottom:10px; ">
    <div class="bill-header">
	  <h3 style="color: black;">‡∞ï‡±ä‡∞®‡±Å‡∞¨‡∞°‡∞ø ‡∞¨‡∞ø‡∞≤‡±ç‡∞≤‡±Å</h3>
      <h1>üå¥ ‡∞ó‡±Ä‡∞§‡∞æ ‡∞™‡±ç‡∞∞‡∞®‡±Ç‡∞∑ ‡∞ï‡±ã‡∞®‡∞∏‡±Ä‡∞Æ ‡∞ï‡±ã‡∞ï‡±ã‡∞®‡∞ü‡±ç ‡∞¨‡∞ø‡∞ú‡∞ø‡∞®‡±Ü‡∞∏‡±ç üå¥</h1>
      <h3>‡∞Æ‡∞ó‡∞ü‡∞™‡∞≤‡±ç‡∞≤‡∞ø</h3>
      <div style="font-weight:700; margin-top:6px; color: #2D9966;">‡∞™‡±ç‡∞∞‡±ã: ‡∞ó‡±Å‡∞Ç‡∞°‡∞æ‡∞¨‡∞§‡±ç‡∞§‡±Å‡∞≤ ‡∞™‡±ç‡∞∞‡∞∏‡∞æ‡∞¶‡±ç</div>
      <div style="font-weight:700; margin-top:6px; color: #A33100;">‡∞∏‡±Ü‡∞≤‡±ç: 9177682498, 9963153332</div>
    </div>

    <!-- customer name (now larger) and date label -->
    <div class="meta-row" style="margin-top:10px;">
      <div class="item" style="flex:1;">
        <label style="font-size:0.95rem;">‡∞ï‡±ä‡∞®‡±Å‡∞ó‡±ã‡∞≤‡±Å‡∞¶‡∞æ‡∞∞‡±Å ‡∞™‡±á‡∞∞‡±Å</label>
        <input id="customerName" style="width:350px" type="text" placeholder="" class="full" />
      </div>

      <div class="item" style="width:160px;">
        <label style="font-size:0.95rem;">‡∞§‡±á‡∞¶‡±Ä</label>
        <!-- date shown as plain label (no input borders) -->
        <div id="billDate" style="padding:8px 10px; border-radius:6px; background:transparent; font-weight:700;"></div>
      </div>
    </div>
  </div>

  <!-- main content sections -->
  <div class="card" style="margin-bottom:10px;">
    <header>‡∞ï‡±ä‡∞¨‡±ç‡∞¨‡∞∞‡∞ø‡∞ï‡∞æ‡∞Ø‡∞≤‡±Å</header>
    <div class="content">
      <div class="grid">
        <label for="asalu">‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞ï‡±ä‡∞¨‡±ç‡∞¨‡∞∞‡∞ø‡∞ï‡∞æ‡∞Ø‡∞≤‡±Å</label>
        <input id="asalu" name="asalu" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label for="senagalu100">‡∞∏‡±Ü‡∞®‡∞ó‡∞≤‡±Å ‡∞§‡±Ä‡∞∏‡±á‡∞Ø‡∞µ‡∞≤‡∞∏‡∞ø‡∞®‡∞µ‡∞ø (%)</label>
        <input id="senagalu100" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label for="senagalu">‡∞∏‡±Ü‡∞®‡∞ó‡∞≤‡±Å ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç</label>
        <input id="senagalu" type="number" readonly />
      </div>
      <div class="grid">
        <label>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞ï‡∞æ‡∞Ø‡∞≤‡±Å (‡∞∏‡±Ü‡∞®‡∞ó‡∞≤‡±Å ‡∞§‡±Ä‡∞∏‡∞ø‡∞® ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§)</label>
        <input id="finalCount" type="number" readonly />
      </div>
      <div class="grid">
        <label>‡∞∞‡±á‡∞ü‡±Å (‚Çπ) 1000 ‡∞ï‡∞æ‡∞Ø‡∞≤‡∞ï‡±Å</label>
        <input id="rate" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>

      <div class="total">
        <span>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞∞‡±Å‡∞∏‡±Å‡∞Æ‡±Å</span>
        <span id="finalAmount">‚Çπ 0.00</span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:10px;">
    <header>‡∞ñ‡∞∞‡±ç‡∞ö‡±Å‡∞≤‡±Å</header>
    <div class="content">
      <div class="grid">
        <label>‡∞¶‡∞ø‡∞Ç‡∞™‡±Å ‡∞í‡∞ï‡±ç‡∞ï ‡∞ï‡±ä‡∞¨‡±ç‡∞¨‡∞∞‡∞ø‡∞ï‡∞æ‡∞Ø‡∞ï‡∞ø</label>
        <input id="dimpuPer" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label>‡∞¶‡∞ø‡∞Ç‡∞™‡±Å ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç (‡∞ï‡∞æ‡∞Ø‡∞≤‡∞ï‡±Å)</label>
        <input id="dimpuValaki" type="number" readonly />
      </div>
      <div class="grid">
        <label>‡∞≤‡±á‡∞¨‡∞∞‡±ç ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å‡∞≤‡±Å</label>
        <input id="labour" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label>‡∞ü‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞∏‡±ç‚Äå‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å‡∞≤‡±Å</label>
        <input id="transport" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>
      <div class="grid">
        <label>‡∞á‡∞§‡∞∞ ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å‡∞≤‡±Å</label>
        <input id="other" type="number" inputmode="numeric" min="0" step="1" value="0" />
      </div>

      <div class="total">
        <span>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å‡∞≤‡±Å</span>
        <span id="expensesFinal">‚Çπ 0.00</span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:10px;">
    <header>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞∞‡±Å‡∞∏‡±Å‡∞Æ‡±Å</header>
    <div class="content">
      <div class="grid">
        <label>‡∞ï‡∞æ‡∞Ø‡∞≤‡±Å ‡∞∞‡±Å‡∞∏‡±Å‡∞Æ‡±Å</label>
        <input id="amountKayalu" style="width:75%" type="text" readonly />
      </div>
      <div class="grid">
        <label>‡∞ñ‡∞∞‡±ç‡∞ö‡±Å‡∞≤‡±Å ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç‡∞ó‡∞æ</label>
        <input id="amountKarchulu" style="width:75%" type="text" readonly />
      </div>

      <div class="total">
        <span>Final Amount</span>
        <span id="finalTotal">‚Çπ 0.00</span>
      </div>
    </div>
  </div>

  <!-- Bottom action card -->
  <!--div class="card" style="padding:12px; margin-bottom:24px;"-->
    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      <!--button onclick="doPrint()" class="ghost">Print</button>
      <button class="primary" id="generatePdfBtn" onclick="generatePDF()" title="Generate compact PDF">Generate PDF</button-->
      <button id="shareImgBtn" onclick="shareAsImage()">Share Image</button>
    </div>
  <!--/div-->
<br>


  <!-- final area: generated date + buttons moved to bottom -->
  <div style="text-align:center; font-size:0.9rem; color:var(--muted); margin-bottom:12px;">
    This bill is generated on: <span id="generatedDate"></span>
  </div>

  <!-- final area: generated date + buttons moved to bottom -->
  <div style="text-align:center; font-size:0.9rem; color:var(--muted); margin-bottom:12px;">
    Developed and designed by Prasad Punnam</span>
  </div>

</div> <!-- end #bill -->

<!-- scripts -->
<script>
/* Utility helpers */
function toNumber(id){
  const el = document.getElementById(id);
  if (!el) return 0;
  const v = parseFloat(el.value.toString().replace(/[^0-9.-]/g,''));
  return isNaN(v) ? 0 : v;
}
function formatINR(n){ return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(n); }

/* Calculation logic */
function recalc(){
  const asalu = toNumber('asalu');
  const senagalu100 = toNumber('senagalu100');
  let senagalu = 0;
  if(senagalu100 > 0){ senagalu = Math.ceil(asalu * (senagalu100/100)); }
  document.getElementById('senagalu').value = senagalu;

  const rate = toNumber('rate');
  const finalCount = Math.max(0, asalu - senagalu);
  document.getElementById('finalCount').value = finalCount;

  const kayaluAmount = finalCount * (rate/1000);
  document.getElementById('finalAmount').textContent = formatINR(kayaluAmount);

  const dimpuPer = toNumber('dimpuPer'), labour = toNumber('labour'), transport = toNumber('transport'), other = toNumber('other');
  const dimpuValaki = asalu * dimpuPer;
  document.getElementById('dimpuValaki').value = dimpuValaki;

  const karchuluAmount = dimpuValaki + labour + transport + other;
  document.getElementById('expensesFinal').textContent = formatINR(karchuluAmount);

  document.getElementById('amountKayalu').value = formatINR(kayaluAmount);
  document.getElementById('amountKarchulu').value = formatINR(karchuluAmount);

  const finalTotal = kayaluAmount - karchuluAmount;
  document.getElementById('finalTotal').textContent = formatINR(finalTotal);

  document.getElementById('generatedDate').textContent = new Date().toLocaleString('en-IN');
}

/* wire inputs */
['asalu','senagalu100','rate','dimpuPer','labour','transport','other'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', recalc);
});
recalc();

/* show bill date as DD-MM-YYYY label (not input) */
(function initDateLabel(){
  const d = new Date();
  const pad = n => n.toString().padStart(2,'0');
  const dd = pad(d.getDate()), mm = pad(d.getMonth()+1), yyyy = d.getFullYear();
  const dateStr = `${dd}-${mm}-${yyyy}`;
  const el = document.getElementById('billDate');
  if (el) el.textContent = dateStr;
})();

/* Print function (single Print button) */
function doPrint(){
  const el = document.getElementById('bill');
  if (!el) return alert('No bill to print.');
  const content = el.outerHTML;
  const styles = Array.from(document.querySelectorAll('style')).map(s => s.outerHTML).join('\n');
  const pageStyle = `<style>@page{size:A4;margin:12mm;} .no-print,.btns{display:none!important;} </style>`;
  const win = window.open('', '_blank', 'noopener,width=900,height=1200');
  win.document.open();
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">${styles}${pageStyle}</head><body>${content}</body></html>`);
  win.document.close();
  setTimeout(()=>{ win.focus(); win.print(); }, 500);
}

/* --- PDF generation: single sensible size and better pagination ---
   - default page size: A4 portrait (keeps pages small)
   - smaller scale to avoid long tall canvas
   - slice canvas into page-height chunks using mm->px conversion
*/
async function generatePDF(){
  try {
    const btn = document.getElementById('generatePdfBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    if (!window.html2canvas) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    if (!window.jspdf) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

    const { jsPDF } = window.jspdf;
    const element = document.getElementById('bill');

    // choose a modest scale to keep canvas reasonably sized on mobile
    const scale = 1.0; // 1.0 gives balanced quality vs size

    const canvas = await html2canvas(element, { scale, useCORS:true, backgroundColor:'#ffffff' });

    // PDF A4 mm
    const pageWidthMm = 210, pageHeightMm = 297, marginMm = 8;
    const dpi = 96 * scale; // px per inch
    const mmToPx = mm => Math.round(mm * (dpi / 25.4));
    const pageHeightPx = mmToPx(pageHeightMm - marginMm*2);
    const pageWidthPx = mmToPx(pageWidthMm - marginMm*2);

    const fullWidth = canvas.width, fullHeight = canvas.height;

    // create pdf
    const pdf = new jsPDF({ unit:'mm', format:[pageWidthMm,pageHeightMm], orientation:'portrait' });
    const displayWidthMM = pageWidthMm - marginMm*2;
    // slice canvas vertically
    let y = 0, pageIndex = 0;
    while (y < fullHeight) {
      const sliceHeight = Math.min(pageHeightPx, fullHeight - y);
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = fullWidth;
      tmpCanvas.height = sliceHeight;
      const ctx = tmpCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, y, fullWidth, sliceHeight, 0, 0, fullWidth, sliceHeight);
      const imgData = tmpCanvas.toDataURL('image/jpeg', 0.92);
      const sliceDisplayHeightMM = (sliceHeight * displayWidthMM) / fullWidth;

      if (pageIndex > 0) pdf.addPage();
      pdf.addImage(imgData, 'JPEG', marginMm, marginMm, displayWidthMM, sliceDisplayHeightMM);

      y += sliceHeight;
      pageIndex++;
    }

    const filename = `bill-${new Date().toISOString().replace(/[:.]/g,'-')}.pdf`;
    const blob = pdf.output('blob');

    // download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);

    // try native share for files
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, { type: 'application/pdf' })] })) {
      try { await navigator.share({ files: [new File([blob], filename, { type: 'application/pdf' })], title: 'Bill PDF' }); } catch(e){ /* may cancel */ }
    } else {
      // already downloaded
    }

  } catch (err) {
    console.error('PDF gen error', err);
    alert('Failed to create PDF. See console for details.');
  } finally {
    const btn = document.getElementById('generatePdfBtn');
    if (btn) { btn.disabled = false; btn.textContent = 'Generate PDF'; }
  }
}

/* --- Share as Image: capture whole bill as one image and share or download --- */
async function shareAsImage(){
  try {
    const btn = document.getElementById('shareImgBtn');
    btn.disabled = true;
    btn.textContent = 'Preparing...';

    if (!window.html2canvas) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');

    // capture at higher scale for better quality but limited to avoid huge images
    const scale = 1.5;
    const canvas = await html2canvas(document.getElementById('bill'), { scale, useCORS:true, backgroundColor:'#ffffff' });
    // convert to blob (png)
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 0.95));

    const fileName = `bill-${new Date().toISOString().replace(/[:.]/g,'-')}.png`;

    // Try Web Share API with files
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'image/png' })] })) {
      try {
        await navigator.share({ files: [new File([blob], fileName, { type: 'image/png' })], title: 'Bill Image' });
        btn.textContent = 'Shared';
        setTimeout(()=> btn.textContent = 'Share Image', 1200);
        return;
      } catch (err) {
        // user cancelled or share not allowed
        console.warn('Share failed or canceled:', err);
      }
    }

    // fallback: download the PNG
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    alert('Image downloaded. You can share it from your device.');

  } catch (err) {
    console.error('Share image error', err);
    alert('Failed to create/share image. Check console for details.');
  } finally {
    const btn = document.getElementById('shareImgBtn');
    if (btn) { btn.disabled = false; btn.textContent = 'Share Image'; }
  }
}

/* helper to load scripts dynamically */
function loadScript(src){ return new Promise((resolve,reject)=>{ if (document.querySelector(`script[src="${src}"]`)) return resolve(); const s=document.createElement('script'); s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); }); }
</script>

</body>
</html>
